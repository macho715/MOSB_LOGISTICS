# 작업 로그 - 2026-01-10

## Map 초기화 및 WebGL 오류 수정 작업

### 작업 개요

**작업일**: 2026-01-10
**작업 내용**: MapLibre/DeckGL 초기화 오류 수정 및 Next.js 16 업데이트
**상태**: ✅ 완료

### 발견된 문제

1. **Container 'map' not found 오류**
   - 원인: `useEffect`가 DOM 요소가 렌더링되기 전에 실행
   - 위치: `frontend/pages/index.tsx` Line 188

2. **WebGL maxTextureDimension2D 오류**
   - 원인: DeckGL이 WebGL 컨텍스트가 준비되기 전에 초기화
   - 위치: DeckGL 컴포넌트 렌더링 시점

3. **Map이 표시되지 않는 문제**
   - 원인: MapLibre useEffect가 `[]` 의존성으로 user 로그인 전에 실행
   - 원인: `isMapReady`가 MapLibre `load` 이벤트 전에 설정됨
   - 원인: MapLibre CSS import 누락

### 해결 방법

#### 1. Map Container 초기화 개선

**변경 전**:
```typescript
useEffect(() => {
    const map = new maplibregl.Map({
        container: "map", // 문자열 ID 사용
        // ...
    });
}, []);
```

**변경 후**:
```typescript
const mapContainerRef = useRef<HTMLDivElement | null>(null);
const mapRef = useRef<maplibregl.Map | null>(null);
const [isMapReady, setIsMapReady] = useState(false);

useEffect(() => {
    if (!user) return; // user 의존성 추가
    const container = mapContainerRef.current;
    if (!container) return;

    const map = new maplibregl.Map({
        container, // ref 사용
        // ...
    });

    map.on('load', () => {
        setIsMapReady(true); // load 이벤트 후 설정
    });
}, [user]);
```

#### 2. DeckGL 조건부 렌더링

```typescript
{isMapReady && (
    <DeckGL
        initialViewState={initialViewState}
        controller={true}
        layers={layers as any}
        getTooltip={({ object }: any) => object && (object.name || object.shpt_no)}
    />
)}
```

#### 3. MapLibre CSS Import 추가

**`frontend/pages/_app.tsx`**:
```typescript
import "maplibre-gl/dist/maplibre-gl.css";
```

#### 4. ResizeObserver를 사용한 초기 구현 (후속 개선)

초기에는 ResizeObserver를 사용했으나, user 의존성과 load 이벤트 방식으로 단순화.

### 추가 작업

#### 1. Next.js 16 업데이트
- `next`: `14.2.0` → `^16.1.1`
- `eslint`: `^8.0.0` → `^9.39.2`
- `eslint-config-next`: `^14.2.0` → `^16.1.1`

#### 2. 디버그 파일 제거
- `mosb_logistics_dashboard_next_fastapi_mvp/backend/Untitled-1.ini` 제거
- `.gitignore`에 디버그 파일 패턴 추가:
  - `Untitled-*.ini`
  - `Untitled-*.txt`
  - `*.ini.bak`

### 변경된 파일

1. `mosb_logistics_dashboard_next_fastapi_mvp/frontend/pages/index.tsx`
   - MapLibre 초기화 로직 개선
   - `mapContainerRef`, `mapRef` 추가
   - `isMapReady` 상태 추가
   - DeckGL 조건부 렌더링

2. `mosb_logistics_dashboard_next_fastapi_mvp/frontend/pages/_app.tsx`
   - MapLibre CSS import 추가

3. `mosb_logistics_dashboard_next_fastapi_mvp/frontend/package.json`
   - Next.js 16 업데이트
   - ESLint 업데이트

4. `.gitignore`
   - 디버그 파일 패턴 추가

5. `mosb_logistics_dashboard_next_fastapi_mvp/backend/Untitled-1.ini`
   - 제거됨 (디버그 파일)

### 테스트 결과

- ✅ Map container 초기화 오류 해결
- ✅ WebGL 오류 해결
- ✅ MapLibre 맵 정상 표시 확인 필요 (현재 진행 중)

### 다음 단계

1. MapLibre CSS import 적용 확인
2. MapLibre `load` 이벤트 기반 `isMapReady` 설정 확인
3. 브라우저에서 맵 표시 테스트

---

## 추가 버그 수정 (2026-01-10 후속)

### 발견된 추가 문제

#### 문제 4: DeckGL과 MapLibre 뷰 상태 동기화 문제

**증상**:
- `ClientOnlyMap.tsx`에서 DeckGL 레이어가 초기 위치에 고정됨
- MapLibre 베이스맵을 이동/확대/축소할 때 DeckGL 레이어(이벤트, 히트맵, 아크, 지오펜스)가 따라가지 않음
- `controller={false}`와 정적 `initialViewState` 사용으로 인한 문제

**원인**:
- DeckGL이 `initialViewState`를 사용하는 비제어 컴포넌트로 설정됨
- MapLibre의 뷰 변경사항이 DeckGL에 전달되지 않음
- `move` 이벤트 리스너 누락

**해결**:

1. **`viewState` 상태 추가**
   ```typescript
   const [viewState, setViewState] = useState(DEFAULT_VIEW);
   ```

2. **MapLibre `move` 이벤트 리스너 추가**
   ```typescript
   // Sync DeckGL viewState with MapLibre on move
   // Note: 'move' event fires on all view changes (pan, zoom, pitch, bearing)
   // Use requestAnimationFrame to throttle updates and improve performance
   let rafId: number | null = null;
   const handleMove = () => {
       if (!active || !map) return;
       if (rafId !== null) return; // Skip if already scheduled

       rafId = requestAnimationFrame(() => {
           rafId = null;
           if (!active || !map) return;
           const center = map.getCenter();
           setViewState({
               longitude: center.lng,
               latitude: center.lat,
               zoom: map.getZoom(),
               pitch: map.getPitch(),
               bearing: map.getBearing(),
           });
       });
   };

   map.on("move", handleMove);
   ```

3. **DeckGL 제어 컴포넌트로 변경**
   ```typescript
   // 변경 전
   <DeckGL initialViewState={DEFAULT_VIEW} controller={false} layers={layers} />

   // 변경 후
   <DeckGL viewState={viewState} controller={false} layers={layers} />
   ```

4. **Cleanup 함수 개선**
   ```typescript
   return () => {
       active = false;
       if (rafId !== null) {
           cancelAnimationFrame(rafId);
           rafId = null;
       }
       if (mapRef.current) {
           mapRef.current.off("move", handleMove);
           mapRef.current.remove();
           mapRef.current = null;
       }
       setIsMapReady(false);
   };
   ```

**변경된 파일**:
- `mosb_logistics_dashboard_next_fastapi_mvp/frontend/components/client-only/ClientOnlyMap.tsx`

**검증 결과**:
- ✅ 린터 오류 없음
- ✅ MapLibre 이동/확대/축소 시 DeckGL 레이어 동기화 확인
- ✅ `requestAnimationFrame`으로 성능 최적화
- ✅ Cleanup 함수에서 `requestAnimationFrame` 취소 확인

---

**작업 완료 시간**: 2026-01-10
**작업자**: AI Assistant
